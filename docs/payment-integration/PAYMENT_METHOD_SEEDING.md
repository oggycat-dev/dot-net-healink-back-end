# üí≥ Payment Method Seeding Guide

## üìã Summary

**Purpose**: Seed initial `PaymentMethod` data for the PaymentService on first startup.

**Status**: ‚úÖ IMPLEMENTED

**File**: `src/PaymentService/PaymentService.Infrastructure/Extensions/PaymentSeedingExtension.cs`

---

## üéØ Payment Methods Seeded

### Active Payment Methods (3)

#### 1. Momo - E-Wallet ‚úÖ

```json
{
  "id": "<auto-generated>",
  "name": "Thanh To√°n b·∫±ng Momo",
  "description": "ƒê√¢y l√† thanh to√°n b·∫±ng Momo",
  "type": 3,
  "typeName": "EWallet",
  "providerName": "Momo",
  "configuration": "{}",
  "status": 1,
  "statusName": "Active",
  "createdAt": "<system-time>",
  "createdBy": "00000000-0000-0000-0000-000000000001",
  "isDeleted": false
}
```

**Details**:
- **Type**: `PaymentType.EWallet` (3)
- **Provider**: Momo (matches `PaymentGatewayType.Momo`)
- **Status**: Active (1)
- **Use Case**: Subscription payments, in-app purchases

---

#### 2. VnPay - E-Wallet ‚úÖ

```json
{
  "id": "<auto-generated>",
  "name": "Thanh To√°n b·∫±ng VnPay",
  "description": "Thanh to√°n qua c·ªïng VnPay",
  "type": 3,
  "typeName": "EWallet",
  "providerName": "VnPay",
  "configuration": "{}",
  "status": 1,
  "statusName": "Active",
  "createdAt": "<system-time>",
  "createdBy": "00000000-0000-0000-0000-000000000001",
  "isDeleted": false
}
```

**Details**:
- **Type**: `PaymentType.EWallet` (3)
- **Provider**: VnPay (matches `PaymentGatewayType.VnPay`)
- **Status**: Active (1)
- **Use Case**: Alternative payment gateway for Vietnam market

---

#### 3. PayPal - Credit Card ‚úÖ

```json
{
  "id": "<auto-generated>",
  "name": "Thanh To√°n b·∫±ng PayPal",
  "description": "Thanh to√°n qu·ªëc t·∫ø qua PayPal",
  "type": 1,
  "typeName": "CreditCard",
  "providerName": "PayPal",
  "configuration": "{}",
  "status": 1,
  "statusName": "Active",
  "createdAt": "<system-time>",
  "createdBy": "00000000-0000-0000-0000-000000000001",
  "isDeleted": false
}
```

**Details**:
- **Type**: `PaymentType.CreditCard` (1)
- **Provider**: PayPal (matches `PaymentGatewayType.PayPal`)
- **Status**: Active (1)
- **Use Case**: International payments, credit card processing

---

### Inactive Payment Methods (2)

These are seeded but **inactive** for future use:

#### 4. Cash - For Future Use üîµ

```json
{
  "id": "<auto-generated>",
  "name": "Thanh To√°n Ti·ªÅn M·∫∑t",
  "description": "Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi giao h√†ng",
  "type": 2,
  "typeName": "Cash",
  "providerName": "Cash",
  "configuration": "{}",
  "status": 0,
  "statusName": "Inactive",
  "createdAt": "<system-time>",
  "createdBy": "00000000-0000-0000-0000-000000000001",
  "isDeleted": false
}
```

**Note**: Can be activated via CMS when cash-on-delivery is supported.

---

#### 5. Bank Transfer - For Future Use üîµ

```json
{
  "id": "<auto-generated>",
  "name": "Chuy·ªÉn Kho·∫£n Ng√¢n H√†ng",
  "description": "Chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp qua ng√¢n h√†ng",
  "type": 4,
  "typeName": "BankTransfer",
  "providerName": "BankTransfer",
  "configuration": "{}",
  "status": 0,
  "statusName": "Inactive",
  "createdAt": "<system-time>",
  "createdBy": "00000000-0000-0000-0000-000000000001",
  "isDeleted": false
}
```

**Note**: Can be activated via CMS when bank transfer flow is implemented.

---

## üìä Enums Mapping

### PaymentType Enum

```csharp
public enum PaymentType
{
    CreditCard = 1,    // Credit/Debit cards
    Cash = 2,          // Cash on delivery
    EWallet = 3,       // E-wallets (Momo, VnPay, etc.)
    BankTransfer = 4   // Direct bank transfer
}
```

---

### PaymentGatewayType Enum

```csharp
public enum PaymentGatewayType
{
    Momo,     // Momo e-wallet
    VnPay,    // VnPay payment gateway
    PayPal    // PayPal international
}
```

---

### EntityStatusEnum

```csharp
public enum EntityStatusEnum
{
    Inactive = 0,  // Not available for use
    Active = 1     // Available for use
}
```

---

## üöÄ How Seeding Works

### 1. Startup Flow

```
Application Start
    ‚Üì
Program.cs
    ‚Üì
await app.SeedPaymentDataAsync(logger);
    ‚Üì
PaymentSeedingExtension.SeedPaymentDataAsync()
    ‚Üì
Check Configuration: EnableSeeding = true?
    ‚Üì Yes
SeedPaymentMethodsAsync()
    ‚Üì
Check: PaymentMethods.Any() exists?
    ‚Üì No (first run)
Create 5 PaymentMethods
    ‚Üì
SaveChangesAsync()
    ‚úÖ Done!
```

---

### 2. Code Flow

```csharp
public static async Task SeedPaymentDataAsync(this IApplicationBuilder app, ILogger logger)
{
    // 1. Check configuration
    var enableSeeding = configuration.GetSection("DataConfig")
        .GetValue<bool>("EnableSeeding");
    
    if (!enableSeeding)
    {
        logger.LogInformation("PaymentService: Data seeding is disabled.");
        return;
    }
    
    // 2. Seed PaymentMethods
    await SeedPaymentMethodsAsync(context, logger);
}

private static async Task SeedPaymentMethodsAsync(PaymentDbContext context, ILogger logger)
{
    // 1. Check if already seeded
    if (await context.PaymentMethods.AnyAsync())
    {
        logger.LogInformation("PaymentService: PaymentMethods already seeded, skipping...");
        return; // ‚úÖ Idempotent!
    }
    
    // 2. Create payment methods
    var paymentMethods = new List<PaymentMethod>
    {
        // Momo, VnPay, PayPal (Active)
        // Cash, BankTransfer (Inactive)
    };
    
    // 3. Save to database
    await context.PaymentMethods.AddRangeAsync(paymentMethods);
    await context.SaveChangesAsync();
}
```

---

## ‚öôÔ∏è Configuration

### appsettings.json

```json
{
  "DataConfig": {
    "EnableSeeding": true  // ‚úÖ Enable seeding on startup
  }
}
```

**Environment Variables** (Override for Production):

```bash
DataConfig__EnableSeeding=false  # Disable in production after first run
```

---

## üß™ Testing

### Test 1: First Run (Seeding)

```bash
# Clear database
dotnet ef database drop -p PaymentService.Infrastructure -s PaymentService.API --force

# Run migrations
dotnet ef database update -p PaymentService.Infrastructure -s PaymentService.API

# Start application (seeding runs automatically)
dotnet run --project PaymentService.API

# Expected logs:
# PaymentService: Starting payment data seeding...
# PaymentService: Seeding PaymentMethods...
# PaymentService: Successfully seeded 5 PaymentMethods
```

---

### Test 2: Subsequent Run (Idempotent)

```bash
# Start application again
dotnet run --project PaymentService.API

# Expected logs:
# PaymentService: Starting payment data seeding...
# PaymentService: PaymentMethods already seeded, skipping...
```

**‚úÖ Idempotent**: Seeding only runs once!

---

### Test 3: Verify Database

```sql
-- Check seeded payment methods
SELECT 
    "Id",
    "Name",
    "Type",
    "ProviderName",
    "Status",
    "CreatedAt"
FROM "PaymentMethods"
ORDER BY "Status" DESC, "Name";
```

**Expected Result**:

| Name | Type | ProviderName | Status |
|------|------|--------------|--------|
| Thanh To√°n b·∫±ng Momo | 3 | Momo | Active |
| Thanh To√°n b·∫±ng PayPal | 1 | PayPal | Active |
| Thanh To√°n b·∫±ng VnPay | 3 | VnPay | Active |
| Chuy·ªÉn Kho·∫£n Ng√¢n H√†ng | 4 | BankTransfer | Inactive |
| Thanh To√°n Ti·ªÅn M·∫∑t | 2 | Cash | Inactive |

---

### Test 4: API Verification

```bash
# Get all payment methods (CMS)
GET /api/cms/payment-methods

# Expected response:
{
  "isSuccess": true,
  "data": {
    "items": [
      {
        "id": "...",
        "name": "Thanh To√°n b·∫±ng Momo",
        "type": 3,
        "typeName": "EWallet",
        "providerName": "Momo",
        "status": 1,
        "statusName": "Active"
      },
      // ... 4 more methods
    ],
    "totalItems": 5
  }
}
```

---

## üîß Manual Management

### Activate Inactive Payment Methods

```bash
# Via CMS API
PUT /api/cms/payment-methods/{id}
{
  "name": "Thanh To√°n Ti·ªÅn M·∫∑t",
  "description": "Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi giao h√†ng",
  "type": 2,
  "providerName": "Cash",
  "configuration": "{}",
  "status": 1  # ‚úÖ Change to Active
}
```

---

### Add New Payment Method

```bash
POST /api/cms/payment-methods
{
  "name": "ZaloPay",
  "description": "Thanh to√°n qua ZaloPay",
  "type": 3,
  "providerName": "ZaloPay",
  "configuration": "{}",
  "status": 1
}
```

---

## üìä Database Schema

### PaymentMethods Table

```sql
CREATE TABLE "PaymentMethods" (
    "Id" UUID PRIMARY KEY,
    "Name" VARCHAR(100) NOT NULL UNIQUE,
    "Description" VARCHAR(500),
    "Type" INTEGER NOT NULL,
    "ProviderName" VARCHAR(100) NOT NULL,
    "Configuration" JSONB,  -- For gateway-specific settings
    "Status" INTEGER NOT NULL,
    "CreatedAt" TIMESTAMP,
    "CreatedBy" UUID,
    "UpdatedAt" TIMESTAMP,
    "UpdatedBy" UUID,
    "IsDeleted" BOOLEAN DEFAULT FALSE,
    "DeletedAt" TIMESTAMP,
    "DeletedBy" UUID
);

CREATE UNIQUE INDEX "IX_PaymentMethods_Name" ON "PaymentMethods" ("Name");
CREATE INDEX "IX_PaymentMethods_Type" ON "PaymentMethods" ("Type");
CREATE INDEX "IX_PaymentMethods_Status" ON "PaymentMethods" ("Status");
```

---

## üéØ Use Cases

### 1. Subscription Payment

```csharp
// User selects payment method
var momoMethod = await _paymentMethodRepo.GetByProviderNameAsync("Momo");

// Create payment intent
var paymentIntent = new CreatePaymentIntentRequest
{
    PaymentMethodId = momoMethod.Id,  // ‚úÖ Seeded Momo method
    Amount = 100000,
    Currency = "VND"
};

var result = await _paymentGatewayFactory
    .GetService(PaymentGatewayType.Momo)
    .CreatePaymentIntentAsync(paymentIntent);
```

---

### 2. Display Available Payment Methods

```csharp
// Get active payment methods
var activeMethods = await _paymentMethodRepo
    .GetAllAsync(filter => filter.Status == EntityStatusEnum.Active);

// Return to frontend
return activeMethods.Select(m => new PaymentMethodDto
{
    Id = m.Id,
    Name = m.Name,
    Type = m.Type,
    Icon = GetIconByType(m.Type)  // Display icon based on type
});
```

---

## üö¶ Production Considerations

### 1. Disable Seeding After First Run

```bash
# Set environment variable
DataConfig__EnableSeeding=false
```

Or use configuration per environment:

```json
// appsettings.Production.json
{
  "DataConfig": {
    "EnableSeeding": false  // Don't re-seed in production
  }
}
```

---

### 2. Gateway Configuration

Update `Configuration` field with gateway-specific settings:

```sql
-- Update Momo configuration
UPDATE "PaymentMethods"
SET "Configuration" = '{
    "PartnerCode": "your-partner-code",
    "AccessKey": "your-access-key",
    "SecretKey": "your-secret-key",
    "ApiUrl": "https://payment.momo.vn/v2/gateway/api/create"
}'::jsonb
WHERE "ProviderName" = 'Momo';
```

**‚ö†Ô∏è Security Note**: Don't store sensitive keys in database. Use environment variables or Azure Key Vault!

---

### 3. Add Custom Payment Methods

```csharp
// Via CMS or admin panel
var newMethod = new PaymentMethod
{
    Name = "Apple Pay",
    Description = "Pay with Apple Pay",
    Type = PaymentType.CreditCard,
    ProviderName = "ApplePay",
    Configuration = "{}",
    Status = EntityStatusEnum.Active
};

await _paymentMethodRepo.AddAsync(newMethod);
```

---

## üìö Related Files

| File | Purpose |
|------|---------|
| `PaymentSeedingExtension.cs` | Seeding logic |
| `PaymentMethod.cs` | Entity model |
| `PaymentType.cs` | Type enum |
| `PaymentGatewayType.cs` | Gateway enum |
| `PaymentDbContext.cs` | Database configuration |
| `Program.cs` | Seeding registration |

---

## ‚úÖ Summary

**What was seeded**:
- ‚úÖ 3 Active payment methods (Momo, VnPay, PayPal)
- ‚úÖ 2 Inactive payment methods (Cash, BankTransfer)

**Benefits**:
- ‚úÖ Ready-to-use payment methods on first startup
- ‚úÖ Idempotent (won't duplicate on subsequent runs)
- ‚úÖ Configurable via `EnableSeeding` setting
- ‚úÖ Manageable via CMS API

**Next Steps**:
1. Configure gateway API keys in environment variables
2. Test payment flows with seeded methods
3. Add more payment methods via CMS as needed
4. Monitor payment transactions

---

**Status**: ‚úÖ READY FOR USE
**Build**: ‚úÖ Succeeded
**Category**: Data Seeding & Configuration

