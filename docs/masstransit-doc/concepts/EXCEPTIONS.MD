# Tá»•ng quan vá» Xá»­ lÃ½ lá»—i (Exceptions) trong MassTransit

TÃ i liá»‡u nÃ y tá»•ng há»£p cÃ¡c khÃ¡i niá»‡m cá»‘t lÃµi vá» cÃ¡ch MassTransit xá»­ lÃ½ lá»—i khi cÃ³ má»™t exception xáº£y ra bÃªn trong **Consumer**, dá»±a trÃªn documentation chÃ­nh thá»©c.

---

## 1. Khi Exception xáº£y ra

Khi má»™t exception khÃ´ng Ä‘Æ°á»£c báº¯t (unhandled) bá»‹ nÃ©m ra tá»« phÆ°Æ¡ng thá»©c `Consume` cá»§a báº¡n, MassTransit sáº½ tá»± Ä‘á»™ng báº¯t nÃ³ vÃ  kÃ­ch hoáº¡t má»™t chuá»—i cÃ¡c cÆ¡ cháº¿ xá»­ lÃ½ lá»—i Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng phá»¥c há»“i má»™t cÃ¡ch an toÃ n.

Luá»“ng xá»­ lÃ½ lá»—i máº·c Ä‘á»‹nh gá»“m 2 bÆ°á»›c chÃ­nh: **Retry** vÃ  **Move to Error Queue**.

---

## 2. Retry: Cá»‘ gáº¯ng thá»­ láº¡i ğŸ”

Retry lÃ  tuyáº¿n phÃ²ng thá»§ Ä‘áº§u tiÃªn. MassTransit sáº½ tá»± Ä‘á»™ng thá»­ láº¡i viá»‡c xá»­ lÃ½ message vá»›i hy vá»ng ráº±ng lá»—i chá»‰ lÃ  táº¡m thá»i (transient), vÃ­ dá»¥ nhÆ° máº¥t káº¿t ná»‘i database táº¡m thá»i hoáº·c má»™t service khÃ¡c bá»‹ quÃ¡ táº£i.

### CÃ¡c chÃ­nh sÃ¡ch Retry tÃ­ch há»£p sáºµn:
* **Immediate:** Thá»­ láº¡i ngay láº­p tá»©c.
* **Interval:** Thá»­ láº¡i sau má»™t khoáº£ng thá»i gian cá»‘ Ä‘á»‹nh.
* **Exponential:** Thá»­ láº¡i vá»›i khoáº£ng thá»i gian tÄƒng theo cáº¥p sá»‘ nhÃ¢n (vÃ­ dá»¥: 2, 4, 8, 16 giÃ¢y). ÄÃ¢y lÃ  chÃ­nh sÃ¡ch ráº¥t hiá»‡u quáº£.
* **Incremental:** Thá»­ láº¡i vá»›i khoáº£ng thá»i gian tÄƒng dáº§n theo má»™t háº±ng sá»‘ (vÃ­ dá»¥: 2, 4, 6, 8 giÃ¢y).

### CÃ¡ch cáº¥u hÃ¬nh Retry:
Báº¡n cÃ³ thá»ƒ cáº¥u hÃ¬nh retry policy trÃªn má»™t endpoint hoáº·c trÃªn má»™t Consumer Definition.

```csharp
// Cáº¥u hÃ¬nh retry policy trÃªn má»™t endpoint
cfg.ReceiveEndpoint("my-queue", e =>
{
    // Thá»­ láº¡i 5 láº§n, vá»›i khoáº£ng thá»i gian tÄƒng dáº§n: 1s, 2s, 4s...
    e.UseMessageRetry(r => r.Exponential(5, 
        TimeSpan.FromSeconds(1), 
        TimeSpan.FromMinutes(2), 
        TimeSpan.FromSeconds(2))
    );
    
    e.ConfigureConsumer<MyConsumer>(context);
});
```
Báº¡n cÅ©ng cÃ³ thá»ƒ lá»c Ä‘á»ƒ chá»‰ retry má»™t sá»‘ loáº¡i exception cá»¥ thá»ƒ.

---

## 3. Move to Error Queue: Di chuyá»ƒn Ä‘áº¿n HÃ ng Ä‘á»£i lá»—i â˜£ï¸

Náº¿u message váº«n tháº¥t báº¡i sau khi Ä‘Ã£ thá»­ láº¡i háº¿t sá»‘ láº§n cho phÃ©p, MassTransit sáº½ coi Ä‘Ã³ lÃ  má»™t lá»—i khÃ´ng thá»ƒ phá»¥c há»“i (poison message).

* **HÃ nh Ä‘á»™ng:** Message gá»‘c sáº½ Ä‘Æ°á»£c **di chuyá»ƒn** Ä‘áº¿n má»™t hÃ ng Ä‘á»£i lá»—i Ä‘áº·c biá»‡t. TÃªn cá»§a hÃ ng Ä‘á»£i nÃ y sáº½ lÃ  tÃªn cá»§a queue gá»‘c cá»™ng vá»›i háº­u tá»‘ `_error`. VÃ­ dá»¥: `my-queue_error`.
* **Má»¥c Ä‘Ã­ch:**
    * NgÄƒn cháº·n message lá»—i lÃ m táº¯c ngháº½n queue chÃ­nh.
    * TÃ¡ch biá»‡t cÃ¡c message lá»—i Ä‘á»ƒ cÃ¡c nhÃ  phÃ¡t triá»ƒn hoáº·c quáº£n trá»‹ viÃªn cÃ³ thá»ƒ kiá»ƒm tra vÃ  xá»­ lÃ½ thá»§ cÃ´ng sau nÃ y (vÃ­ dá»¥: sá»­a dá»¯ liá»‡u rá»“i gá»­i láº¡i).

---

## 4. `Fault<T>` Message: Sá»± kiá»‡n lá»—i Ä‘Æ°á»£c Publish ğŸ“¢

Äá»“ng thá»i vá»›i viá»‡c di chuyá»ƒn message Ä‘áº¿n queue lá»—i, MassTransit sáº½ **publish** má»™t message sá»± kiá»‡n Ä‘áº·c biá»‡t cÃ³ kiá»ƒu lÃ  `Fault<TMessage>`, vá»›i `TMessage` lÃ  kiá»ƒu cá»§a message gá»‘c gÃ¢y ra lá»—i.

* **Ná»™i dung:** Message `Fault<T>` chá»©a thÃ´ng tin chi tiáº¿t vá» lá»—i, bao gá»“m:
    * Message gá»‘c.
    * ThÃ´ng tin Exception (stack trace, message).
    * TÃªn mÃ¡y chá»§, thá»i gian xáº£y ra lá»—i.
* **Má»¥c Ä‘Ã­ch:** Cho phÃ©p cÃ¡c service khÃ¡c (nhÆ° service giÃ¡m sÃ¡t, dashboard) cÃ³ thá»ƒ **subscribe** vÃ o cÃ¡c sá»± kiá»‡n lá»—i nÃ y Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng tá»± Ä‘á»™ng nhÆ° gá»­i cáº£nh bÃ¡o cho DevOps, cáº­p nháº­t tráº¡ng thÃ¡i cá»§a má»™t quy trÃ¬nh nghiá»‡p vá»¥ thÃ nh "Tháº¥t báº¡i", v.v.

```csharp
// Má»™t consumer cÃ³ thá»ƒ láº¯ng nghe sá»± kiá»‡n lá»—i cá»§a má»™t message SubmitOrder
public class SubmitOrderFaultConsumer : IConsumer<Fault<SubmitOrder>>
{
    public Task Consume(ConsumeContext<Fault<SubmitOrder>> context)
    {
        // Gá»­i email hoáº·c tin nháº¯n Slack cho Ä‘á»™i phÃ¡t triá»ƒn
        Console.WriteLine($"Lá»—i khi xá»­ lÃ½ Ä‘Æ¡n hÃ ng: {context.Message.Message.OrderId}, lá»—i: {context.Message.Exceptions.FirstOrDefault()?.Message}");
        return Task.CompletedTask;
    }
}
```

---

## 5. Redelivery vÃ  Idempotency (Giao láº¡i vÃ  TÃ­nh báº¥t biáº¿n)

Do cÆ¡ cháº¿ retry vÃ  cÃ¡c lá»—i máº¡ng, má»™t message cÃ³ thá»ƒ Ä‘Æ°á»£c giao Ä‘áº¿n consumer **nhiá»u hÆ¡n má»™t láº§n**. Do Ä‘Ã³, consumer cá»§a báº¡n pháº£i Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ cÃ³ **tÃ­nh báº¥t biáº¿n (idempotent)**, nghÄ©a lÃ  viá»‡c xá»­ lÃ½ cÃ¹ng má»™t message nhiá»u láº§n pháº£i cho ra cÃ¹ng má»™t káº¿t quáº£ vÃ  khÃ´ng gÃ¢y ra tÃ¡c dá»¥ng phá»¥ tiÃªu cá»±c.

MassTransit cung cáº¥p cÃ¡c header nhÆ° `MessageId`, `ConversationId`, `CorrelationId` Ä‘á»ƒ giÃºp báº¡n xÃ¡c Ä‘á»‹nh vÃ  xá»­ lÃ½ cÃ¡c message trÃ¹ng láº·p.

---

## 6. The Outbox Pattern: Äáº£m báº£o tÃ­nh nháº¥t quÃ¡n

Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» "dual-write" (vÃ­ dá»¥: lÆ°u vÃ o database thÃ nh cÃ´ng nhÆ°ng gá»­i message tháº¥t báº¡i), MassTransit cung cáº¥p **Outbox Pattern**.

* **CÃ¡ch hoáº¡t Ä‘á»™ng:** CÃ¡c message báº¡n muá»‘n gá»­i/publish tá»« bÃªn trong má»™t consumer sáº½ khÃ´ng Ä‘Æ°á»£c gá»­i Ä‘i ngay. Thay vÃ o Ä‘Ã³, chÃºng Ä‘Æ°á»£c lÆ°u táº¡m vÃ o má»™t "há»™p thÆ° Ä‘i" (outbox) trong cÃ¹ng má»™t transaction vá»›i database cá»§a báº¡n.
* **Lá»£i Ã­ch:** Äáº£m báº£o ráº±ng cÃ¡c message chá»‰ Ä‘Æ°á»£c gá»­i Ä‘i **KHI VÃ€ CHá»ˆ KHI** transaction cá»§a consumer (vÃ­ dá»¥: `_dbContext.SaveChangesAsync()`) thÃ nh cÃ´ng. Äiá»u nÃ y Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n tuyá»‡t Ä‘á»‘i giá»¯a tráº¡ng thÃ¡i database vÃ  cÃ¡c message Ä‘Æ°á»£c gá»­i ra ngoÃ i.
* **CÃ¡ch dÃ¹ng:** KÃ­ch hoáº¡t thÃ´ng qua `UseInMemoryOutbox()` hoáº·c `UseEntityFrameworkOutbox()`.