# Tá»•ng quan vá» Messages trong MassTransit

TÃ i liá»‡u nÃ y tá»•ng há»£p cÃ¡c khÃ¡i niá»‡m cá»‘t lÃµi vá» message trong MassTransit, dá»±a trÃªn documentation chÃ­nh thá»©c. **Message** lÃ  má»™t "há»£p Ä‘á»“ng" (contract) Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a dÆ°á»›i dáº¡ng má»™t Ä‘á»‘i tÆ°á»£ng .NET, dÃ¹ng Ä‘á»ƒ giao tiáº¿p giá»¯a cÃ¡c service.

## CÃ¡c loáº¡i Message

MassTransit phÃ¢n loáº¡i message dá»±a trÃªn **Ã½ Ä‘á»‹nh (intent)**. CÃ³ ba loáº¡i chÃ­nh: Commands, Events, vÃ  Documents.

---

### 1. Commands (Lá»‡nh) â¡ï¸

**Ã Ä‘á»‹nh:** Ra lá»‡nh cho má»™t service khÃ¡c **lÃ m má»™t Ä‘iá»u gÃ¬ Ä‘Ã³**.

* **Äáº·c Ä‘iá»ƒm:**
    * TÃªn thÆ°á»ng lÃ  má»™t Ä‘á»™ng tá»« á»Ÿ dáº¡ng má»‡nh lá»‡nh (vÃ­ dá»¥: `SubmitOrder`, `UpdateCustomerAddress`).
    * Thá»ƒ hiá»‡n má»‘i quan há»‡ **1-1** (má»™t ngÆ°á»i gá»­i, má»™t ngÆ°á»i nháº­n).
    * ÄÆ°á»£c **gá»­i (sent)** Ä‘áº¿n má»™t endpoint (má»™t queue) cá»¥ thá»ƒ.
* **CÃ¡ch dÃ¹ng:**
    * Sá»­ dá»¥ng `ISendEndpoint` hoáº·c `IBus` Ä‘á»ƒ `Send()` má»™t command.
    * Lá»‡nh khÃ´ng nÃªn Ä‘Æ°á»£c publish.

```csharp
// VÃ­ dá»¥ vá» má»™t Command
public interface SubmitOrder
{
    Guid OrderId { get; }
    DateTime OrderDate { get; }
    string CustomerNumber { get; }
}
```

---

### 2. Events (Sá»± kiá»‡n) ğŸ“¢

**Ã Ä‘á»‹nh:** ThÃ´ng bÃ¡o ráº±ng **má»™t Ä‘iá»u gÃ¬ Ä‘Ã³ Ä‘Ã£ xáº£y ra**.

* **Äáº·c Ä‘iá»ƒm:**
    * TÃªn thÆ°á»ng lÃ  má»™t Ä‘á»™ng tá»« á»Ÿ thÃ¬ quÃ¡ khá»© (vÃ­ dá»¥: `OrderSubmitted`, `CustomerAddressUpdated`).
    * Thá»ƒ hiá»‡n má»‘i quan há»‡ **1-n** (má»™t ngÆ°á»i phÃ¡t hÃ nh, nhiá»u ngÆ°á»i Ä‘Äƒng kÃ½).
    * ÄÆ°á»£c **xuáº¥t báº£n (published)** cho táº¥t cáº£ cÃ¡c consumer quan tÃ¢m.
    * Sá»± kiá»‡n pháº£i lÃ  **báº¥t biáº¿n (immutable)**.
* **CÃ¡ch dÃ¹ng:**
    * Sá»­ dá»¥ng `IPublishEndpoint` hoáº·c `IBus` Ä‘á»ƒ `Publish()` má»™t event.

```csharp
// VÃ­ dá»¥ vá» má»™t Event
public interface OrderSubmitted
{
    Guid OrderId { get; }
    DateTime OrderDate { get; }
    string CustomerNumber { get; }
}
```

---

### 3. Documents (TÃ i liá»‡u) ğŸ“„

**Ã Ä‘á»‹nh:** Má»™t loáº¡i message lá»›n hÆ¡n, dÃ¹ng Ä‘á»ƒ chuyá»ƒn giao dá»¯ liá»‡u hoáº·c tráº¡ng thÃ¡i. ThÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c máº«u kiáº¿n trÃºc nÃ¢ng cao nhÆ° Event Sourcing hoáº·c CQRS. MassTransit khÃ´ng cÃ³ Ä‘á»‹nh nghÄ©a cháº·t cháº½ cho loáº¡i nÃ y, nhÆ°ng nÃ³ khÃ¡c vá»›i command vÃ  event.

---

## NguyÃªn táº¯c thiáº¿t káº¿ Message Contracts

Äá»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng dá»… báº£o trÃ¬ vÃ  má»Ÿ rá»™ng, hÃ£y tuÃ¢n thá»§ cÃ¡c nguyÃªn táº¯c sau khi thiáº¿t káº¿ message.

### âœ… NÃªn dÃ¹ng Interfaces
Sá»­ dá»¥ng interface cho message contracts lÃ  cÃ¡ch lÃ m tá»‘t nháº¥t (best practice).
* **TÃ¡ch biá»‡t:** TÃ¡ch biá»‡t hoÃ n toÃ n "há»£p Ä‘á»“ng" khá»i viá»‡c triá»ƒn khai.
* **Linh hoáº¡t:** Dá»… dÃ ng cho viá»‡c versioning vÃ  chia sáº» giá»¯a cÃ¡c service.
* **Gá»n nháº¹:** Chá»‰ Ä‘á»‹nh nghÄ©a nhá»¯ng gÃ¬ cáº§n thiáº¿t.

### âœ… NÃªn lÃ  Báº¥t biáº¿n (Immutable)
Message contracts nÃªn lÃ  báº¥t biáº¿n.
* CÃ¡c thuá»™c tÃ­nh chá»‰ nÃªn cÃ³ `get`.
* Vá»›i C# 9+, cÃ³ thá»ƒ dÃ¹ng `init` Ä‘á»ƒ cho phÃ©p khá»Ÿi táº¡o giÃ¡ trá»‹ ban Ä‘áº§u.
* Äiá»u nÃ y Ä‘áº£m báº£o message khÃ´ng bá»‹ thay Ä‘á»•i trong quÃ¡ trÃ¬nh váº­n chuyá»ƒn vÃ  xá»­ lÃ½.

```csharp
// VÃ­ dá»¥ vá» contract báº¥t biáº¿n
public interface UpdateCustomerAddress
{
    Guid CustomerId { get; init; }
    string NewAddress { get; init; }
}
```

### âœ… Giá»¯ cho Message tinh gá»n
* Chá»‰ bao gá»“m cÃ¡c thuá»™c tÃ­nh dá»¯ liá»‡u Ä‘Æ¡n giáº£n (primitive types, strings, numbers, booleans) vÃ  cÃ¡c kiá»ƒu phá»©c há»£p (complex types).
* **KhÃ´ng** bao gá»“m cÃ¡c hÃ nh vi (methods) hay logic nghiá»‡p vá»¥.
* **KhÃ´ng** bao gá»“m cÃ¡c kiá»ƒu dá»¯ liá»‡u khÃ³ hoáº·c khÃ´ng thá»ƒ serialize, nhÆ° `Stream`, `Task`, `Delegate`.

Message chá»‰ Ä‘Æ¡n giáº£n lÃ  má»™t "Äá»‘i tÆ°á»£ng Truyá»n táº£i Dá»¯ liá»‡u" (Data Transfer Object - DTO).